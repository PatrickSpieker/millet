#!/bin/sh

set -eu

usage() {
cat <<EOF
usage:
  $0 [options] <file>...

options:
  -h
    show this help
  -g
    generate new expected output from resulting output
EOF
exit 1
}

generate=false
while getopts 'hg' opt; do
  case "$opt" in
  (g) generate=true ;;
  (*) usage ;;
  esac
done
shift "$((OPTIND - 1))"

if [ "$#" -eq 0 ]; then
  usage
fi

ok=true
old_pwd="$PWD"
for x in "$@"; do
  cd "$x"
  if [ -e run.sh ]; then
    if sh -eu run.sh; then
      echo "$x: ok"
    else
      echo "$x: expected run.sh to exit zero, got non-zero"
      ok=false
    fi
  elif [ -e ast.sml ]; then
    if ! NO_COLOR=1 cargo run --quiet --bin millet -- --just-ast ast.sml >out.tmp; then
      echo "$x: expected success, got failure"
      ok=false
    elif "$generate"; then
      mv out.tmp out.txt
      echo "$x: generated"
    elif diff out.txt out.tmp; then
      rm out.tmp
      echo "$x: ok"
    else
      echo "$x: expected lhs, got rhs"
      ok=false
    fi
  elif [ -e ok.sml ]; then
    if ! NO_COLOR=1 cargo run --quiet --bin millet -- --quiet ok.sml >out.tmp; then
      echo "$x: expected success, got failure"
      ok=false
    elif [ -s out.tmp ]; then
      echo "$x: expected no output, got output"
      ok=false
    else
      rm out.tmp
      echo "$x: ok"
    fi
  elif [ -e err.sml ]; then
    if NO_COLOR=1 cargo run --quiet --bin millet -- err.sml >out.tmp; then
      echo "$x: expected failure, got success"
      ok=false
    elif "$generate"; then
      mv out.tmp out.txt
      echo "$x: generated"
    elif diff out.txt out.tmp; then
      rm out.tmp
      echo "$x: ok"
    else
      echo "$x: expected lhs, got rhs"
      ok=false
    fi
  else
    echo "$x: don't know how to run"
    ok=false
  fi
  cd "$old_pwd"
done

if "$ok"; then
  echo "==> all tests ok"
else
  echo "==> some tests not ok"
  exit 1
fi
