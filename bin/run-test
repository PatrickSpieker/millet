#!/bin/sh

set -eu

usage() {
cat <<EOF
usage:
  $0 [options]

options:
  -h
    show this help
  -g
    generate new expected output from resulting output
EOF
exit 1
}

generate=false
while getopts 'hg' opt; do
  case "$opt" in
  (g) generate=true ;;
  (*) usage ;;
  esac
done
shift "$((OPTIND - 1))"

if [ "$#" -eq 0 ]; then
  usage
fi

ok=true
old_pwd="$PWD"
rm_out_txt=false
for x in "$@"; do
  rm_out_txt=false
  cd "$old_pwd"
  cd "$x"
  if [ -e run.sh ]; then
    if ! sh -eu run.sh; then
      echo "$x: expected run.sh to exit zero, got non-zero"
      ok=false
      continue
    fi
  elif [ -e ok.sml ]; then
    if ! NO_COLOR=1 cargo run --quiet --bin millet -- ok.sml >out.tmp; then
      echo "$x: expected success, got failure"
      ok=false
      continue
    fi
    echo "no errors" >out.txt
    rm_out_txt=true
  elif [ -e err.sml ]; then
    if NO_COLOR=1 cargo run --quiet --bin millet -- err.sml >out.tmp; then
      echo "$x: expected failure, got success"
      ok=false
      continue
    fi
  else
    echo "$x: don't know how to run"
    ok=false
    continue
  fi
  if "$generate"; then
    mv out.tmp out.txt
    echo "$x: generated"
    continue
  fi
  if ! diff out.txt out.tmp; then
    if "$rm_out_txt"; then
      rm out.txt
    fi
    echo "$x: expected lhs, got rhs"
    ok=false
    continue
  fi
  if "$rm_out_txt"; then
    rm out.txt
  fi
  rm out.tmp
  echo "$x: ok"
done

if "$ok"; then
  echo "==> all tests ok"
else
  echo "==> some tests not ok"
  exit 1
fi
