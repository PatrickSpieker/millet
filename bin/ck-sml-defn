#!/bin/sh

set -eu

if [ "$#" -ne 0 ]; then
  echo "usage: $0"
  exit 1
fi

NUM_RULES=89

mk_temp_dir() {
  while true; do
    name="/tmp/$(od -N 4 -tu /dev/random | awk 'NR == 1 { print $2 }')"
    if mkdir -m 700 "$name" 2>/dev/null; then
      echo "$name"
      break
    fi
  done
}

temp="$(mk_temp_dir)"
trap "rm -rf $temp" EXIT
seq 1 "$NUM_RULES" >"$temp/want"
git grep -ho 'SML Definition ([[:digit:]]*)' -- crates/core/src/statics |
  tr -d 'A-Za-z ()' |
  sort -nu >"$temp/got"
comm -23 "$temp/want" "$temp/got" >"$temp/want_not_got"
if [ -s "$temp/want_not_got" ]; then
  echo "the following rules were not referenced:"
  cat "$temp/want_not_got"
  exit 1
fi
comm -13 "$temp/want" "$temp/got" >"$temp/got_not_want"
if [ -s "$temp/got_not_want" ]; then
  echo "the following rules were unexpectedly referenced:"
  cat "$temp/got_not_want"
  exit 1
fi
echo "all and only the rules from 1-$NUM_RULES were referenced"
